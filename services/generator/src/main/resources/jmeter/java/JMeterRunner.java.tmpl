@args() {
  String scripts
}
package org.ats.generated;

import java.io.BufferedReader;
import java.io.File;
import java.io.FileOutputStream;
import java.io.FileReader;
import java.io.IOException;
import java.util.ArrayList;
import java.util.List;

import org.apache.jmeter.engine.DistributedRunner;
import org.apache.jmeter.save.SaveService;
import org.apache.jmeter.testelement.TestPlan;
import org.apache.jmeter.threads.RemoteThreadsListenerTestElement;
import org.apache.jmeter.threads.ThreadGroup;
import org.apache.jmeter.util.JMeterUtils;
import org.apache.jorphan.collections.HashTree;
import org.apache.jorphan.collections.ListedHashTree;
import org.testng.annotations.BeforeClass;
import org.testng.annotations.Test;

public class JMeterRunner {

  private List<String> hostList = new ArrayList<String>();
  
  @@BeforeClass
  public void setup() {
    JMeterUtils.loadJMeterProperties("src/test/resources/jmeter/bin/jmeter.properties");
    JMeterUtils.setJMeterHome("src/test/resources/jmeter");
    
    String hosts = System.getProperty("jmeter.hosts");
    if (hosts == null || hosts.isEmpty()) throw new IllegalArgumentException("Need at least an host to run jmeter");
    
    String[] args = hosts.split(",");
    for (String arg : args) {
      hostList.add(arg.trim());
    }
  }

  @scripts
  
  private void shutdown(String logFile) throws Exception {
    while(true) {
      File file = new File(logFile);
      if (!file.exists()) continue;
      BufferedReader reader = new BufferedReader(new FileReader(file));
      String line = null;
      while ((line = reader.readLine()) != null) {
        if (line.indexOf("Shutdown Test Thread") != -1) {
          reader.close();
          return;
        }
      }
      reader.close();
      Thread.sleep(5000);
    }
  }
  
}
